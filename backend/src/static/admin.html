<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin – Import & Delete Photos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { 
        --bg:#0b0c0f; 
        --card:#12141a; 
        --ink:#e6e8ee; 
        --muted:#9aa3b2; 
        --accent:#6ea8fe; 
        --danger:#ff6b6b; 
        --border:#1e2230; 
    }
    * { 
        box-sizing: border-box; 
    }
    html, body { 
        height: 100%; 
    }
    body { 
        margin:0; 
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; 
        color:var(--ink); 
        background: linear-gradient(180deg, #0b0c0f, #0f1117); 
    }
    h1, h2, h3 { 
        margin: 0 0 8px; 
    }
    a { 
        color: var(--accent); 
    }

    .wrap { 
        max-width: 1100px; 
        margin: 24px auto; 
        padding: 0 16px; 
    }
    .header { 
        display:flex; 
        align-items:center; 
        justify-content: space-between; 
        margin-bottom: 16px; 
    }
    .slugRow { 
        display:flex; 
        gap:8px; 
        align-items:center; 
        flex-wrap: wrap; 
    }
    input[type="text"] { 
        background:var(--card); 
        color:var(--ink); 
        border:1px solid var(--border); 
        padding:10px 12px; 
        border-radius:10px; 
        outline:none; 
        min-width: 260px; 
    }
    input[type="text"]::placeholder{ 
        color:var(--muted); 
    }
    button { 
        background:#1a5fff; 
        color:white; 
        border:none; 
        padding:10px 14px; 
        border-radius:10px; 
        cursor:pointer; 
        font-weight:600; 
    }
    button.secondary { 
        background:#262b3a; 
        color:var(--ink); 
    }
    button.ghost { 
        background:transparent; 
        border:1px solid var(--border); 
    }
    button.danger { 
        background: var(--danger); 
    }
    button:disabled { 
        opacity:.5; 
        cursor:not-allowed; 
    }
    .segmented { 
        display:flex; 
        flex-wrap:wrap; 
        gap:8px; 
        width: 100%;
    }
    .chip {
    background:#262b3a; 
    color:var(--ink); 
    border:1px solid var(--border);
    
    padding:8px 12px; 
    border-radius:999px; 
    cursor:pointer; 
    font-weight:600;
  
    }
    .chip.active { 
        background:#1a5fff; 
        color:#fff; 
        border-color:white; 
    }
    .cards { 
        display:grid; 
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
        gap: 16px; 
    }
    .card { 
        background:var(--card); 
        border:1px solid var(--border); 
        border-radius:16px; 
        padding:16px; 
        box-shadow: 0 4px 16px rgba(0,0,0,.25); 
    }
    .card .row { 
        display:flex; 
        gap:8px; 
        flex-wrap: wrap; 
        align-items:center; 
    }
    .muted { 
        color: var(--muted); 
        font-size: 13px; 
    }
    .status { 
        margin-top:8px; 
        font-size: 14px; 
        min-height: 21px; 
    }

    .grid { 
        display:grid; 
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
        gap:12px; 
        margin-top:12px; 
    }
    .item { 
        border:1px solid var(--border); 
        border-radius:12px; 
        overflow:hidden; 
        background:#0f1322; 
    }
    .thumb { 
        width: 100%; 
        height: 120px; 
        object-fit: cover; 
        display:block; 
    }
    .item .bar { 
        display:flex; 
        justify-content: space-between; 
        align-items:center; 
        gap:8px; 
        padding:8px; 
    }
    .item small { 
        color: var(--muted); 
        font-size: 11px; 
    }

    .toolbar { 
        display:flex; 
        align-items:center; 
        gap:8px; 
        margin-top:12px; 
    }
    .pill { 
        display:inline-flex; 
        align-items:center; 
        gap:6px; 
        border:1px solid var(--border); 
        padding:6px 10px; 
        border-radius:999px; 
        font-size:12px; 
    }
    .spacer { 
        flex:1; 
    }

    pre.code { 
        background:#0f1322; 
        border:1px solid var(--border); 
        color:#dbe4ff; 
        padding:12px; 
        border-radius:12px; 
        max-height: 180px; 
        overflow:auto; 
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Admin</h1>
        <div class="muted">Import from Google Photos and delete items — all in one place.</div>
      </div>
      <div class="pill">Secure area</div>
    </div>

    <div class="slugRow">
        <div class="segmented" id="sectionPicker"></div>

      <!-- keep slug but hide it; the picker will set this -->
      <input id="slug" type="hidden" />

      <!-- title stays visible so you can override the default if you want -->

      <button id="loadBtn" class="secondary">Load Items</button>
      <button id="refreshBtn" class="ghost">Refresh</button>
    </div>

    <div class="cards" style="margin-top:16px;">
      <!-- Import Card -->
      <section class="card" id="importCard">
        <h2>Import from Google Photos</h2>
        <div class="muted">Opens the Google Photos Picker in a new tab and auto-imports the selection into the current section.</div>
        <div class="toolbar">
          <button id="startPicker">Start Picker</button>
          <div class="spacer"></div>
          <button id="showPreview" class="ghost">Toggle Preview</button>
        </div>
        <div id="importStatus" class="status"></div>
        <pre id="preview" class="code" style="display:none"></pre>
      </section>

      <!-- Delete Card -->
      <section class="card" id="deleteCard">
        <h2>Delete Items</h2>
        <div class="toolbar">
          <button id="deleteSelected" class="danger" disabled>Delete Selected</button>
          <div class="spacer"></div>
          <span class="muted" id="countLabel">0 loaded</span>
        </div>
        <div id="deleteStatus" class="status"></div>
        <div id="grid" class="grid"></div>
      </section>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const els = {
      slug: $('#slug'),
      title: $('#title') || null,
      loadBtn: $('#loadBtn'),
      refreshBtn: $('#refreshBtn'),
      startPicker: $('#startPicker'),
      showPreview: $('#showPreview'),
      importStatus: $('#importStatus'),
      preview: $('#preview'),
      deleteStatus: $('#deleteStatus'),
      deleteSelected: $('#deleteSelected'),
      grid: $('#grid'),
      countLabel: $('#countLabel'),
    };
    
      // Define your finite set here
      const SECTIONS = [
        { slug: 'pfp',       title: 'Profile Picture' },
        { slug: 'dancer',   title: 'Dance — Dancer' },
        { slug: 'choreography',   title: 'Dance — Choreographer' },
        { slug: 'acting',    title: 'Film — Acting' },
        { slug: 'production',title: 'Film — Production' },
        { slug: 'modeling',       title: 'Modeling' },
        // add/remove as needed
      ];

      let selectedSection = null;

      function renderSectionPicker() {
        const picker = document.getElementById('sectionPicker');
        picker.innerHTML = SECTIONS.map(s =>
          `<button class="chip" data-slug="${s.slug}" data-title="${s.title}">${s.title}</button>`
        ).join('');

        picker.addEventListener('click', (e) => {
          const btn = e.target.closest('.chip');
          if (!btn) return;
          setSection(btn.dataset.slug);
        });

        // Choose a default on load
        setSection(SECTIONS[0].slug);
      }

      function setSection(slug) {
        selectedSection = SECTIONS.find(s => s.slug === slug) || null;

        // reflect selection in hidden slug + UI
        els.slug.value = selectedSection ? selectedSection.slug : '';
        // only touch title if it exists
        if (els.title) {
            els.title.placeholder = selectedSection ? selectedSection.title : 'section title (for new imports)';
        }
        // toggle active chip
        document.querySelectorAll('#sectionPicker .chip').forEach(chip => {
          chip.classList.toggle('active', chip.dataset.slug === slug);
        });
      }

    
    // --- Shared helpers ---
    // replace your existing getSlug() with:
      function getSlug() {
        const s = (els.slug.value || '').trim();
        if (!s) throw new Error('Pick a section.');
        return s;
      }

      function getTitleFallback(slug) {
        const typed = (els.title && els.title.value ? els.title.value.trim() : '');
        if (typed) return typed;
        if (selectedSection && selectedSection.slug === slug) return selectedSection.title;
        return slug;
      }
    
    function setStatus(el, msg) { el.textContent = msg || ''; }

    // --- Import flow (Picker) ---
    let importedOnce = false;
    async function startPickerFlow() {
      try {
        const slug = getSlug();
        const sectionTitle = getTitleFallback(slug);
        setStatus(els.importStatus, 'Creating Picker session…');

        // Create a Picker session on the backend (expects JSON back)
        const res = await fetch('/picker/sessions', {
          method: 'POST',
          headers: { 'Accept': 'application/json' },
          credentials: 'include'
        });

        // Not logged in? navigate to OAuth (XHR cannot follow cross-origin redirects)
        if (res.status === 401) {
          const returnTo = '/admin.html#resume=picker';
          window.location.assign('/auth/google?returnTo=' + encodeURIComponent(returnTo));
          return;
        }

        if (!res.ok) {
          const msg = await res.text().catch(()=>'');
          throw new Error(`Failed to create Picker session (${res.status}). ${msg}`);
        }

        const sess = await res.json();                 // <-- define sess here
        if (!sess || !sess.sessionId || !sess.pickerUri) {
          throw new Error('Failed to create Picker session.');
        }

        // Open Picker and start polling
        window.open(sess.pickerUri, '_blank');
        setStatus(els.importStatus, 'Waiting for selection… (switch to the Picker tab)');

        const poll = async () => {
          const r = await fetch('/picker/sessions/' + encodeURIComponent(sess.sessionId));
          if (!r.ok) throw new Error('Could not read Picker session.');
          const info = await r.json();

          if (!info.mediaItemsSet) {
            const interval = info.recommendedPollingIntervalMillis || 1200;
            setTimeout(poll, interval);
          } else {
            setStatus(els.importStatus, 'Selection complete. Fetching chosen items…');
            const itemsRes = await fetch('/picker/mediaItems?sessionId=' + encodeURIComponent(sess.sessionId));
            if (!itemsRes.ok) throw new Error('Could not fetch chosen items.');
            const items = await itemsRes.json();
            els.preview.textContent = JSON.stringify(items, null, 2);

            setStatus(els.importStatus, `Importing to section "${sectionTitle}"…`);
            const resp = await fetch('/api/gallery/sections/' + encodeURIComponent(slug) + '/import', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sessionId: sess.sessionId, sectionTitle })
            });
            const data = await resp.json().catch(()=>({}));
            if (resp.ok) {
              setStatus(els.importStatus, 'Imported ' + (data.importedCount || 0) + ' items.');
              await loadItems();
            } else {
              setStatus(els.importStatus, 'Import failed: ' + (data.error || resp.statusText));
            }
          }
        };
        poll();
      } catch (e) {
        setStatus(els.importStatus, e.message || String(e));
      }
    }

        // --- Delete flow ---
    async function loadItems() {
      const slug = getSlug();
      setStatus(els.deleteStatus, 'Loading…');
      els.grid.innerHTML = '';
      els.deleteSelected.disabled = true;
      try {
        const resp = await fetch(`/api/gallery/sections/${encodeURIComponent(slug)}/items`);
        if (!resp.ok) throw new Error(resp.statusText);
        const data = await resp.json();
        const items = data.items || [];
        els.countLabel.textContent = `${items.length} loaded`;
        if (!items.length) {
          setStatus(els.deleteStatus, `No items for "${slug}".`);
          return;
        }
        setStatus(els.deleteStatus, '');

        const frag = document.createDocumentFragment();
        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'item';
          const url = item.fullUrl || item.storage_url;
          div.innerHTML = `
            <img class="thumb" src="${url}" alt=""/>
            <div class="bar">
              <label style="display:flex; align-items:center; gap:8px;">
                <input type="checkbox" class="sel" data-id="${item.id}" />
                <small>ID ${item.id}</small>
              </label>
              <div style="display:flex; gap:6px;">
                <a href="${url}" target="_blank" class="ghost">Open</a>
                <button class="danger delOne" data-id="${item.id}">Delete</button>
              </div>
            </div>`;
          frag.appendChild(div);
        });
        els.grid.appendChild(frag);
      } catch (e) {
        setStatus(els.deleteStatus, 'Error: ' + (e.message || String(e)));
      }
    }

    async function deleteIds(ids) {
      const slug = getSlug();
      setStatus(els.deleteStatus, `Deleting ${ids.length}…`);
      const resp = await fetch(`/api/gallery/sections/${encodeURIComponent(slug)}/delete`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids })
      });
      const data = await resp.json().catch(()=>({}));
      if (!resp.ok) {
        setStatus(els.deleteStatus, 'Delete failed: ' + (data.error || resp.statusText));
      } else {
        setStatus(els.deleteStatus, `Deleted ${data.deletedCount} item(s).`);
        await loadItems();
      }
    }

    // --- Event wiring ---
    els.loadBtn.addEventListener('click', () => loadItems().catch(()=>{}));
    els.refreshBtn.addEventListener('click', () => loadItems().catch(()=>{}));
    els.startPicker.addEventListener('click', () => startPickerFlow());
    els.showPreview.addEventListener('click', () => {
      els.preview.style.display = els.preview.style.display === 'none' ? 'block' : 'none';
    });

    // Delegated handlers for grid
    els.grid.addEventListener('change', () => {
      const any = $$('.sel:checked').length > 0;
      els.deleteSelected.disabled = !any;
    });
    els.grid.addEventListener('click', (e) => {
      const btn = e.target.closest('.delOne');
      if (btn) {
        const id = btn.getAttribute('data-id');
        if (confirm('Delete item ' + id + '?')) {
          deleteIds([id]);
        }
      }
    });
    els.deleteSelected.addEventListener('click', () => {
      const ids = $$('.sel:checked').map(cb => cb.dataset.id);
      if (!ids.length) return;
      if (confirm(`Delete ${ids.length} items?`)) deleteIds(ids);
    });

    // Quality of life: load when slug loses focus or Enter is pressed
    els.slug.addEventListener('keydown', (e) => { if (e.key === 'Enter') els.loadBtn.click(); });
    els.slug.addEventListener('blur', () => { if (els.slug.value.trim()) els.loadBtn.click(); });
    renderSectionPicker();
  </script>
</body>
</html>
