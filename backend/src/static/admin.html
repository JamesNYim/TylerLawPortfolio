<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin · Gallery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0b0c;
      --card: #131316;
      --muted: #9aa0a6;
      --text: #e8eaed;
      --accent: #6ee7b7;
      --danger: #ef4444;
      --border: #26262b;
      --chip: #1b1b20;
    }
    * { box-sizing: border-box }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.45;
    }
    a { color: var(--accent); text-decoration: none }
    a:hover { text-decoration: underline }

    .container {
      max-width: 1100px;
      margin: 24px auto 64px;
      padding: 0 16px;
    }

    header {
      display: grid;
      gap: 8px;
      margin-bottom: 16px;
    }
    header h1 {
      margin: 0;
      font-size: clamp(22px, 3.5vw, 32px);
      letter-spacing: 0.2px;
    }
    .muted { color: var(--muted) }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0 0;
    }
    .chip {
      background: var(--chip);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #fff;
    }
    .chip.active {
      background: var(--text);
      color: #0b0b0c;
      border-color: var(--text);
      font-weight: 600;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    @media (min-width: 700px) {
      .grid { grid-template-columns: repeat(3, 1fr); }
    }
    @media (min-width: 960px) {
      .grid { grid-template-columns: repeat(4, 1fr); }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin: 16px 0;
    }
    .card h2 {
      margin: 0 0 6px;
      font-size: 18px;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0 14px;
    }
    .toolbar .spacer { flex: 1 1 auto }

    .btn {
      background: #1f2937;
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover { filter: brightness(1.1) }
    .btn.primary { background: var(--text); color: #0b0b0c; border-color: var(--text); font-weight: 600 }
    .btn.accent { background: #123; border-color: #1b3b3b; color: var(--accent) }
    .btn.danger { background: #2a1111; border-color: #3b1a1a; color: #ffb4b4 }

    input[type="file"] {
      background: #111215;
      border: 1px dashed var(--border);
      padding: 10px;
      border-radius: 12px;
      color: var(--muted);
      max-width: 100%;
    }

    .status {
      min-height: 20px;
      font-size: 13px;
      color: var(--muted);
    }

    .item {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #0f1013;
      position: relative;
    }
    .thumb {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
      background: #0a0a0c;
    }
    .bar {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
      word-break: break-all;
    }
    .check {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(11,11,12,0.6);
      backdrop-filter: blur(2px);
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
    }
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .help {
      border-left: 3px solid #303036;
      padding-left: 10px;
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 13px;
    }
    code.kbd {
      background: #0f0f12;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1px 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: #c6d0ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Gallery Admin</h1>
      <div class="muted">Pick a section, upload from your computer or import from Google Photos, and manage items.</div>
      <div id="sectionStatus" class="status"></div>
      <div id="sectionChips" class="chips"></div>
    </header>

    <!-- Google Photos import -->
    <section class="card" id="googleCard">
      <h2>Import from Google Photos</h2>
      <div class="muted">Use the Google Picker to choose album(s) or photo(s), then import into the current section.</div>
      <div class="toolbar">
        <button class="btn accent" id="openPicker">Launch Google Picker</button>
        <div class="spacer"></div>
        <span class="muted">Current section: <strong id="currentSectionName">—</strong></span>
      </div>
      <div class="help">
        After picking, you’ll be returned here. Your backend’s picker page is expected at <code class="kbd">/picker.html?returnTo=/admin.html</code>.
      </div>
      <div id="googleStatus" class="status"></div>
    </section>

    <!-- Local file uploads -->
    <section class="card" id="uploadCard">
      <h2>Upload Local Files</h2>
      <div class="muted">Select images or videos from your computer and upload them into the current section.</div>

      <div class="toolbar" style="flex-wrap:wrap">
        <input id="fileInput" type="file" multiple accept="image/*,video/*" />
        <button id="startUpload" class="btn primary">Upload Selected</button>
        <div class="spacer"></div>
        <span class="muted" id="uploadCount">No files chosen</span>
      </div>

      <div id="uploadStatus" class="status"></div>
      <div id="uploadPreview" class="grid"></div>
    </section>

    <!-- Manage items -->
    <section class="card" id="manageCard">
      <h2>Manage Section Items</h2>
      <div class="toolbar">
        <button class="btn" id="refreshItems">Refresh</button>
        <button class="btn danger" id="deleteSelected">Delete Selected</button>
        <div class="spacer"></div>
        <label class="row" style="gap:6px;font-size:13px">
          <input type="checkbox" id="toggleAll" />
          Select all
        </label>
      </div>
      <div id="itemsStatus" class="status"></div>
      <div id="itemsGrid" class="grid"></div>
    </section>
  </div>

  <script>
    // ---------- tiny DOM helpers ----------
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    function setStatus(node, msg, type='info') {
      if (!node) return;
      node.textContent = msg || '';
      node.style.color = type === 'error' ? '#ffb4b4' : type === 'ok' ? '#b4ffd3' : 'var(--muted)';
    }

    // ---------- state ----------
    const state = {
      sections: [],
      activeSlug: null,
      items: [],
      selectedIds: new Set(),
    };

    function getSlug() { return state.activeSlug; }
    function getActiveSection() {
      return state.sections.find(s => s.slug === state.activeSlug) || null;
    }

    // ---------- sections ----------
    async function fetchSections() {
      setStatus($('#sectionStatus'), 'Loading sections…');
      try {
        const r = await fetch('/api/gallery/sections', { credentials: 'include' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        state.sections = Array.isArray(data) ? data : (data.sections || []);
        renderSectionChips();
        if (!state.activeSlug && state.sections[0]) {
          setActiveSection(state.sections[0].slug);
        } else {
          // refresh UI with current
          updateCurrentSectionLabel();
          await loadItems(true);
        }
        setStatus($('#sectionStatus'), '');
      } catch (e) {
        setStatus($('#sectionStatus'), 'Failed to load sections: ' + (e.message || e), 'error');
      }
    }

    function renderSectionChips() {
      const box = $('#sectionChips');
      box.innerHTML = '';
      const frag = document.createDocumentFragment();
      state.sections.forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'chip' + (s.slug === state.activeSlug ? ' active' : '');
        btn.textContent = s.title || s.slug;
        btn.dataset.slug = s.slug;
        btn.addEventListener('click', () => setActiveSection(s.slug));
        frag.appendChild(btn);
      });
      box.appendChild(frag);
    }

    async function setActiveSection(slug) {
      state.activeSlug = slug;
      state.selectedIds.clear();
      renderSectionChips();
      updateCurrentSectionLabel();
      await loadItems(true);
    }

    function updateCurrentSectionLabel() {
      const sec = getActiveSection();
      $('#currentSectionName').textContent = sec ? (sec.title || sec.slug) : '—';
    }

    // ---------- items list ----------
    async function loadItems(showSpin=false) {
      if (!getSlug()) return;
      if (showSpin) setStatus($('#itemsStatus'), 'Loading items…');
      try {
        const r = await fetch(`/api/gallery/sections/${encodeURIComponent(getSlug())}/items`, { credentials: 'include' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        // Accept either array or { items: [] }
        state.items = Array.isArray(data) ? data : (data.items || []);
        state.selectedIds.clear();
        $('#toggleAll').checked = false;
        renderItemsGrid();
        setStatus($('#itemsStatus'), `Loaded ${state.items.length} item(s).`, 'ok');
      } catch (e) {
        setStatus($('#itemsStatus'), 'Failed to load items: ' + (e.message || e), 'error');
      }
    }

    function imgSrcFor(item) {
      return item.thumb_url || item.thumbUrl || item.storage_url || item.storageUrl || item.fullUrl || item.url || '';
    }

    function renderItemsGrid() {
      const grid = $('#itemsGrid');
      grid.innerHTML = '';
      if (!state.items.length) return;

      const frag = document.createDocumentFragment();
      state.items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'item';

        const isImage = (it.mime_type || it.mimeType || '').startsWith('image/') ||
                        /\.(png|jpe?g|webp|avif|gif)$/i.test(imgSrcFor(it));

        const src = imgSrcFor(it);
        div.innerHTML = `
          <label class="check">
            <input type="checkbox" data-id="${it.id}"/>
          </label>
          ${
            isImage
              ? `<img class="thumb" src="${src}" alt="">`
              : `<div class="thumb" style="display:grid;place-items:center;font-size:12px">${it.filename || it.id}</div>`
          }
          <div class="bar">
            <small>${it.filename || it.id}</small>
            <small>#${it.id}</small>
          </div>
        `;
        frag.appendChild(div);
      });
      grid.appendChild(frag);

      // wire checkboxes
      $$('#itemsGrid input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const id = Number(e.target.dataset.id);
          if (e.target.checked) state.selectedIds.add(id);
          else state.selectedIds.delete(id);
        });
      });
    }

    // toggle all
    $('#toggleAll').addEventListener('change', (e) => {
      const on = e.target.checked;
      state.selectedIds.clear();
      $$('#itemsGrid input[type="checkbox"]').forEach(cb => {
        cb.checked = on;
        const id = Number(cb.dataset.id);
        if (on) state.selectedIds.add(id);
      });
    });

    // refresh
    $('#refreshItems').addEventListener('click', () => loadItems(true));

    // delete
    $('#deleteSelected').addEventListener('click', async () => {
      if (!getSlug()) return;
      const ids = Array.from(state.selectedIds);
      if (!ids.length) {
        return setStatus($('#itemsStatus'), 'Select at least one item to delete.');
      }
      if (!confirm(`Delete ${ids.length} item(s)? This cannot be undone.`)) return;

      setStatus($('#itemsStatus'), 'Deleting…');
      try {
        const r = await fetch(`/api/gallery/sections/${encodeURIComponent(getSlug())}/delete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ ids })
        });
        const data = await r.json().catch(()=>({}));
        if (!r.ok) throw new Error(data.error || r.statusText);
        setStatus($('#itemsStatus'), `Deleted ${ids.length} item(s).`, 'ok');
        await loadItems(true);
      } catch (e) {
        setStatus($('#itemsStatus'), 'Failed to delete: ' + (e.message || e), 'error');
      }
    });

    // ---------- upload local files ----------
    const uploadEls = {
      fileInput: document.getElementById('fileInput'),
      startUpload: document.getElementById('startUpload'),
      uploadCount: document.getElementById('uploadCount'),
      uploadStatus: document.getElementById('uploadStatus'),
      uploadPreview: document.getElementById('uploadPreview'),
    };

    function renderUploadPreview(files) {
      const frag = document.createDocumentFragment();
      Array.from(files).forEach(f => {
        const div = document.createElement('div');
        div.className = 'item';
        const isImg = f.type.startsWith('image/');
        const url = URL.createObjectURL(f);
        div.innerHTML = `
          ${isImg ? `<img class="thumb" src="${url}" alt=""/>`
                   : `<div class="thumb" style="display:grid;place-items:center;font-size:12px;">${f.name}</div>`}
          <div class="bar"><small>${f.name}</small><small>${Math.round(f.size/1024)} KB</small></div>
        `;
        frag.appendChild(div);
      });
      uploadEls.uploadPreview.innerHTML = '';
      uploadEls.uploadPreview.appendChild(frag);
    }

    uploadEls.fileInput.addEventListener('change', () => {
      const n = uploadEls.fileInput.files.length;
      uploadEls.uploadCount.textContent = n ? `${n} file(s) selected` : 'No files chosen';
      renderUploadPreview(uploadEls.fileInput.files || []);
    });

    uploadEls.startUpload.addEventListener('click', async () => {
      const files = uploadEls.fileInput.files;
      if (!getSlug()) return setStatus(uploadEls.uploadStatus, 'Pick a section first.');
      if (!files || !files.length) return setStatus(uploadEls.uploadStatus, 'Pick at least one file.');

      try {
        setStatus(uploadEls.uploadStatus, 'Uploading…');
        const form = new FormData();
        Array.from(files).forEach(f => form.append('files', f));
        const resp = await fetch(`/api/gallery/sections/${encodeURIComponent(getSlug())}/upload`, {
          method: 'POST',
          body: form,
          credentials: 'include'
        });
        const data = await resp.json().catch(()=>({}));
        if (!resp.ok) throw new Error(data.error || resp.statusText);
        const n = (data.created && data.created.length) || 0;
        setStatus(uploadEls.uploadStatus, `Uploaded ${n} item(s).`, 'ok');
        uploadEls.fileInput.value = '';
        uploadEls.uploadCount.textContent = 'No files chosen';
        uploadEls.uploadPreview.innerHTML = '';
        await loadItems(true);
      } catch (e) {
        setStatus(uploadEls.uploadStatus, 'Upload failed: ' + (e.message || e), 'error');
      }
    });

    // ---------- google picker ----------
    
    const els = {
      importBtn: document.getElementById('openPicker'),
      importStatus: document.getElementById('googleStatus'),
      preview: { textContent: '' } // optional dump
    };

    function getTitleFallback(slug) {
      const sec = state.sections.find(s => s.slug === slug);
      return (sec && (sec.title || sec.slug)) || slug || 'Untitled';
    }

    async function startPickerFlow() {
      try {
        const slug = getSlug();
        if (!slug) { setStatus(els.importStatus, 'Pick a section first.', 'error'); return; }
        const sectionTitle = getTitleFallback(slug);
        setStatus(els.importStatus, 'Creating Picker session…');

        // 1) Create a session
        const res = await fetch('/picker/sessions', {
          method: 'POST',
          headers: { 'Accept': 'application/json' },
          credentials: 'include'
        });

        // 401 => kick off OAuth, resume after redirect
        if (res.status === 401) {
          const returnTo = '/admin#resume=picker';
          window.location.assign('/auth/google?returnTo=' + encodeURIComponent(returnTo));
          return;
        }
        if (!res.ok) {
          const msg = await res.text().catch(()=> '');
          throw new Error(`Failed to create Picker session (${res.status}). ${msg}`);
        }

        const sess = await res.json();
        if (!sess || !sess.sessionId || !sess.pickerUri) throw new Error('Picker session missing fields.');

        // 2) Open Picker
        window.open(sess.pickerUri, '_blank');
        setStatus(els.importStatus, 'Waiting for selection… (switch to the Picker tab)');

        // 3) Poll until selection is ready
        const poll = async () => {
          const r = await fetch('/picker/sessions/' + encodeURIComponent(sess.sessionId), { credentials: 'include' });
          if (!r.ok) throw new Error('Could not read Picker session.');
          const info = await r.json();

          if (!info.mediaItemsSet) {
            const interval = info.recommendedPollingIntervalMillis || 1200;
            setTimeout(poll, interval);
            return;
          }

          // 4) (optional) fetch picked items just to verify
          setStatus(els.importStatus, 'Selection complete. Fetching chosen items…');
          const itemsRes = await fetch('/picker/mediaItems?sessionId=' + encodeURIComponent(sess.sessionId), { credentials: 'include' });
          if (!itemsRes.ok) throw new Error('Could not fetch chosen items.');
          const items = await itemsRes.json();
          // els.preview.textContent = JSON.stringify(items, null, 2); // debug

          // 5) Import into the current section
          setStatus(els.importStatus, `Importing to section “${sectionTitle}”…`);
          const resp = await fetch('/api/gallery/sections/' + encodeURIComponent(slug) + '/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ sessionId: sess.sessionId, sectionTitle })
          });
          const data = await resp.json().catch(()=> ({}));
          if (!resp.ok) throw new Error('Import failed: ' + (data.error || resp.statusText));

          setStatus(els.importStatus, 'Imported ' + (data.importedCount || 0) + ' item(s).', 'ok');
          await loadItems(true);
        };

        poll();
      } catch (e) {
        setStatus(els.importStatus, e.message || String(e), 'error');
      }
    }

    // Wire button
    els.importBtn.addEventListener('click', startPickerFlow);

    // Auto-resume after OAuth
    (function resumeAfterAuth() {
      const u = new URL(window.location.href);
      if (u.hash === '#resume=picker') {
        history.replaceState(null, '', u.pathname + u.search);
        setTimeout(startPickerFlow, 200);
      }
    })();

    // ---------- boot ----------
    (async function boot() {
      await fetchSections();
      // optional: if URL has ?section=slug, activate it
      const u = new URL(window.location.href);
      const pre = u.searchParams.get('section');
      if (pre && state.sections.some(s => s.slug === pre)) {
        await setActiveSection(pre);
      }
    })();
  </script>
</body>
</html>

